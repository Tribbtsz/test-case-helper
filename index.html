<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>测试用例记录助手</title>
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>
  </head>
  <body class="min-h-screen bg-slate-50">
    <div
      id="app"
      class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8"
      x-data="testcaseApp"
      x-init="init()"
      x-cloak
    >
      <header class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white/80 p-6 shadow-sm backdrop-blur">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <p class="text-sm font-semibold uppercase tracking-wide text-blue-600">测试工作台 · 本地版</p>
            <h1 class="mt-1 text-2xl font-bold text-slate-900">测试用例记录与报告助手</h1>
            <p class="mt-1 text-sm text-slate-600">
              直接读取当前 CSV 用例，便捷打钩、筛选、编辑、统计并生成测试报告；数据仅存储在浏览器或导出文件，默认保留备份。
            </p>
            <p class="mt-2 text-xs text-slate-500">
              来源文件：<span class="font-medium text-slate-700" x-text="sourceFile || '未加载'"></span>
              <template x-if="lastSavedAt">
                <span class="ml-2 text-emerald-600">已保存：<span x-text="formatDateTime(lastSavedAt)"></span></span>
              </template>
            </p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="btn-ghost" :disabled="loading" @click="loadDefault()">加载默认CSV</button>
            <label class="btn-ghost cursor-pointer">
              <input class="sr-only" type="file" accept=".csv" @change="handleFile" />
              导入CSV
            </label>
            <button class="btn-ghost" @click="persist(true, true)">保存到浏览器</button>
            <button class="btn-ghost" @click="exportCsv(false)">导出CSV</button>
            <button class="btn-ghost" @click="exportCsv(true)">导出备份</button>
            <button class="btn-primary" @click="generateReport()">生成报告</button>
            <button class="btn-ghost text-red-600 hover:text-red-700" @click="clearLocal()">清除缓存</button>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3 text-xs text-slate-500">
          <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-1">可离线使用</span>
          <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-1">无后端 / 无登录</span>
          <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-1">本地缓存 + 导出备份</span>
          <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-1">Tailwind + Alpine.js</span>
        </div>
      </header>

      <div class="mt-6 grid gap-4 rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-sm backdrop-blur sm:grid-cols-2 lg:grid-cols-4">
        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-slate-700">关键字</label>
          <input
            type="search"
            class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
            placeholder="用例场景 / ID / 模块 / 预期 / 备注"
            x-model.trim="filters.search"
          />
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-slate-700">测试模块</label>
          <select
            class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
            x-model="filters.module"
          >
            <option value="">全部</option>
            <template x-for="m in modules" :key="m">
              <option :value="m" x-text="m"></option>
            </template>
          </select>
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-slate-700">优先级</label>
          <select
            class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
            x-model="filters.priority"
          >
            <option value="">全部</option>
            <option value="高">高</option>
            <option value="中">中</option>
            <option value="低">低</option>
          </select>
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-slate-700">执行状态</label>
          <select
            class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
            x-model="filters.status"
          >
            <option value="">全部</option>
            <template x-for="s in statusOptions" :key="s">
              <option :value="s" x-text="s"></option>
            </template>
          </select>
        </div>
        <div class="flex flex-wrap items-center gap-2 sm:col-span-2 lg:col-span-4">
          <label class="inline-flex items-center gap-2 text-sm text-slate-700">
            <input type="checkbox" class="rounded border-slate-300 text-blue-600 shadow-sm" x-model="filters.onlyChanged" />
            只看有执行结果
          </label>
          <label class="inline-flex items-center gap-2 text-sm text-slate-700">
            <input type="checkbox" class="rounded border-slate-300 text-blue-600 shadow-sm" x-model="filters.onlyFailed" />
            只看失败 / 阻塞
          </label>
          <div class="flex gap-2 text-xs">
            <span class="badge bg-slate-100 text-slate-700 ring-slate-200">快速筛选</span>
            <button class="btn-ghost px-2 py-1 text-xs" @click="quickFilter('高')">高优</button>
            <button class="btn-ghost px-2 py-1 text-xs" @click="quickFilter('失败')">失败</button>
            <button class="btn-ghost px-2 py-1 text-xs" @click="quickFilter('阻塞')">阻塞</button>
            <button class="btn-ghost px-2 py-1 text-xs" @click="resetFilters()">重置</button>
          </div>
          <div class="ml-auto flex items-center gap-2 text-xs text-slate-500">
            <span>视图</span>
            <button
              class="btn-ghost px-2 py-1 text-xs"
              :class="view === 'table' ? 'ring-2 ring-blue-200 text-blue-600' : ''"
              @click="view = 'table'"
            >
              表格
            </button>
            <button
              class="btn-ghost px-2 py-1 text-xs"
              :class="view === 'cards' ? 'ring-2 ring-blue-200 text-blue-600' : ''"
              @click="view = 'cards'"
            >
              卡片
            </button>
          </div>
        </div>
      </div>

      <section class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <template x-for="card in statCards()" :key="card.label">
          <article class="rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-sm">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-slate-600" x-text="card.label"></p>
              <span class="badge" :class="card.badgeClass" x-text="card.sub"></span>
            </div>
            <p class="mt-2 text-3xl font-semibold text-slate-900" x-text="card.value"></p>
            <p class="mt-1 text-xs text-slate-500" x-text="card.desc"></p>
          </article>
        </template>
      </section>

      <section class="mt-6 rounded-2xl border border-slate-200 bg-white/90 p-4 shadow-sm backdrop-blur">
        <div class="flex flex-wrap items-center gap-3">
          <h2 class="text-lg font-semibold text-slate-900">用例列表</h2>
          <span class="badge bg-slate-100 text-slate-700 ring-slate-200">共 <span x-text="cases.length"></span> 条</span>
          <span class="badge bg-emerald-50 text-emerald-700 ring-emerald-200">筛选结果 <span x-text="filteredCases().length"></span> 条</span>
          <template x-if="loading">
            <span class="text-xs text-blue-600">加载中...</span>
          </template>
          <template x-if="message">
            <span class="text-xs text-amber-600" x-text="message"></span>
          </template>
          <button class="btn-ghost px-3 py-1 text-xs bg-cyan-200 text-cyan-600 hover:bg-cyan-300" @click="copyTemplate()">复制用例模版</button>
          <div class="ml-auto flex gap-2">
            <button class="btn-ghost px-3 py-1 text-xs" @click="setAllStatus('通过')">全标通过</button>
            <button class="btn-ghost px-3 py-1 text-xs" @click="setAllStatus('未执行')">清除执行结果</button>
          </div>
        </div>

        <div class="mt-4">
          <div class="overflow-hidden rounded-xl border border-slate-200" x-show="view === 'table'">
            <div class="overflow-auto">
              <table class="min-w-full divide-y divide-slate-200 text-sm">
                <thead class="bg-slate-50 text-left text-xs font-semibold text-slate-600">
                  <tr>
                    <th class="px-4 py-3">场景 / ID / 模块</th>
                    <th class="px-4 py-3">前置条件</th>
                    <th class="px-4 py-3">测试步骤</th>
                    <th class="px-4 py-3">预期结果</th>
                    <th class="px-4 py-3">状态</th>
                    <th class="px-4 py-3">备注 / 实际</th>
                    <th class="px-4 py-3 text-right">操作</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white">
                  <template x-for="item in filteredCases()" :key="item.id">
                    <tr class="align-top">
                      <td class="px-4 py-3">
                        <div class="flex flex-col gap-2">
                          <p class="text-sm font-semibold" :class="priorityBadge(item.priority)" x-text="item.scenario"></p>
                          <div class="flex flex-wrap items-center gap-2">
                            <span class="font-mono text-xs text-slate-500" x-text="item.id"></span>
                            <span class="rounded bg-slate-100 px-2 py-0.5 text-[11px] text-slate-700" x-text="item.module || '未分组'"></span>
                          </div>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-slate-600">
                        <p class="whitespace-pre-line text-xs" x-text="item.precondition || '-'"></p>
                      </td>
                      <td class="px-4 py-3 text-slate-600">
                        <ul class="list-disc space-y-1 pl-4 text-xs">
                          <template x-for="(step, idx) in item.steps" :key="idx">
                            <li x-text="step"></li>
                          </template>
                        </ul>
                      </td>
                      <td class="px-4 py-3 text-slate-600">
                        <p class="whitespace-pre-line text-xs" x-text="item.expected"></p>
                      </td>
                      <td class="px-4 py-3">
                        <div class="flex flex-col gap-2">
                          <span class="badge w-fit" :class="statusBadge(item.status)" x-text="item.status"></span>
                          <div class="flex flex-wrap gap-1">
                            <template x-for="s in statusOptions" :key="s">
                              <button
                                class="btn-ghost px-2 py-1 text-xs"
                                :class="item.status === s ? 'ring-2 ring-blue-200 text-blue-600' : ''"
                                @click="setStatus(item, s)"
                              >
                                <span x-text="s"></span>
                              </button>
                            </template>
                          </div>
                        </div>
                      </td>
                      <td class="px-4 py-3">
                        <textarea
                          class="w-full rounded-lg border border-slate-200 bg-white px-2 py-1 text-xs focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                          rows="3"
                          placeholder="备注 / 实际结果"
                          x-model="item.actual"
                          @input="markDirty()"
                        ></textarea>
                        <div class="mt-1 text-[11px] text-slate-500">
                          <span x-text="item.remark"></span>
                          <template x-if="item.updatedAt">
                            <span class="ml-1">更新：<span x-text="formatDateTime(item.updatedAt)"></span></span>
                          </template>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-right">
                        <div class="flex flex-wrap justify-end gap-2">
                          <button class="btn-ghost px-2 py-1 text-xs" @click="startEdit(item)">编辑</button>
                          <button class="btn-ghost px-2 py-1 text-xs" @click="setStatus(item, '通过')">通过</button>
                          <button class="btn-ghost px-2 py-1 text-xs" @click="setStatus(item, '失败')">失败</button>
                        </div>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-2" x-show="view === 'cards'">
            <template x-for="item in filteredCases()" :key="item.id">
              <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <div class="flex flex-col gap-2">
                  <div class="flex flex-wrap items-center gap-2">
                    <span class="font-mono text-xs text-slate-500" x-text="item.id"></span>
                    <span class="rounded bg-slate-100 px-2 py-0.5 text-[11px] text-slate-700" x-text="item.module || '未分组'"></span>
                    <span class="badge" :class="statusBadge(item.status)" x-text="item.status"></span>
                  </div>
                  <h3 class="text-base font-semibold" :class="priorityBadge(item.priority)" x-text="item.scenario"></h3>
                  <div class="text-xs text-slate-500">
                    <span>优先级：</span>
                    <span :class="priorityBadge(item.priority)" x-text="item.priority || '-'"></span>
                  </div>
                  <div class="text-xs text-slate-600">
                    <span class="font-medium">前置：</span>
                    <span x-text="item.precondition || '-'"></span>
                  </div>
                  <div class="text-xs text-slate-700">
                    <span class="font-medium">步骤：</span>
                    <ul class="mt-1 list-disc space-y-1 pl-5">
                      <template x-for="(step, idx) in item.steps" :key="idx">
                        <li x-text="step"></li>
                      </template>
                    </ul>
                  </div>
                  <div class="text-xs text-slate-700">
                    <span class="font-medium">预期：</span>
                    <span x-text="item.expected"></span>
                  </div>
                  <textarea
                    class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-2 py-1 text-xs focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                    rows="2"
                    placeholder="备注 / 实际结果"
                    x-model="item.actual"
                    @input="markDirty()"
                  ></textarea>
                  <div class="mt-2 flex flex-wrap gap-2">
                    <template x-for="s in statusOptions" :key="s">
                      <button
                        class="btn-ghost px-2 py-1 text-xs"
                        :class="item.status === s ? 'ring-2 ring-blue-200 text-blue-600' : ''"
                        @click="setStatus(item, s)"
                      >
                        <span x-text="s"></span>
                      </button>
                    </template>
                    <button class="btn-ghost px-2 py-1 text-xs" @click="startEdit(item)">编辑</button>
                  </div>
                  <p class="mt-2 text-[11px] text-slate-500">
                    <template x-if="item.updatedAt">
                      <span>更新：<span x-text="formatDateTime(item.updatedAt)"></span></span>
                    </template>
                  </p>
                </div>
              </article>
            </template>
          </div>
        </div>
      </section>

      <!-- 编辑弹窗 -->
      <div
        x-show="editingItem"
        x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 px-4 py-6"
        x-transition.opacity
        @click.self="cancelEdit()"
      >
        <div class="w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-2xl bg-white p-6 shadow-xl" @click.stop>
          <div class="flex items-center justify-between border-b border-slate-200 pb-4">
            <div>
              <p class="text-xs uppercase text-blue-600">编辑测试用例</p>
              <h3 class="text-lg font-semibold text-slate-900" x-text="editingItem?.id || ''"></h3>
            </div>
            <button class="btn-ghost px-3 py-1 text-sm" @click="cancelEdit()">✕ 关闭</button>
          </div>

          <div class="mt-4 grid gap-4 sm:grid-cols-2">
            <label class="sm:col-span-2 flex flex-col gap-2 text-sm">
              <span class="font-medium text-slate-700">测试场景 / 用例名</span>
              <input
                class="rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                placeholder="如：AI生成并保存作品"
                x-model="editForm.scenario"
                :class="priorityBadge(editForm.priority)"
              />
            </label>
            <label class="flex flex-col gap-2 text-sm">
              <span class="font-medium text-slate-700">优先级</span>
              <select
                class="rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                x-model="editForm.priority"
              >
                <option value="">未设</option>
                <option value="高">高</option>
                <option value="中">中</option>
                <option value="低">低</option>
              </select>
            </label>
            <label class="flex flex-col gap-2 text-sm">
              <span class="font-medium text-slate-700">测试模块</span>
              <input
                class="rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                placeholder="如：作品创建、作品报价等"
                x-model="editForm.module"
              />
            </label>
          </div>

          <div class="mt-4 grid gap-4 sm:grid-cols-2">
            <label class="flex flex-col gap-2 text-sm">
              <span class="font-medium text-slate-700">前置条件</span>
              <textarea
                class="rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                rows="3"
                placeholder="如：用户已登录小程序"
                x-model="editForm.precondition"
              ></textarea>
            </label>
            <label class="flex flex-col gap-2 text-sm">
              <span class="font-medium text-slate-700">预期结果</span>
              <textarea
                class="rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                rows="3"
                placeholder="如：作品保存成功，状态为未获价"
                x-model="editForm.expected"
              ></textarea>
            </label>
            <label class="sm:col-span-2 flex flex-col gap-2 text-sm">
              <span class="font-medium text-slate-700">测试步骤 <span class="text-slate-400">(每行一个步骤)</span></span>
              <textarea
                class="rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                rows="5"
                placeholder="1. 进入AI创作页面&#10;2. 点击生成作品按钮&#10;3. 完成作品上传/生成&#10;4. 保存作品"
                x-model="editForm.editingSteps"
              ></textarea>
            </label>
          </div>

          <div class="mt-6 flex items-center justify-between border-t border-slate-200 pt-4">
            <label class="flex items-center gap-2 text-sm text-slate-600">
              <input type="checkbox" class="rounded border-slate-300 text-blue-600" x-model="saveWithBackup" />
              <span>保存时同时导出备份</span>
            </label>
            <div class="flex gap-3">
              <button class="btn-ghost" @click="cancelEdit()">取消</button>
              <button class="btn-primary" @click="saveEdit(saveWithBackup)">保存修改</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="/src/main.js"></script>
  </body>
</html>
